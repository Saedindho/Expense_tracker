{% extends "base.html" %}
{% block title %}Expenses - Student Expense Tracker{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-1">Expenses</h2>
    {% if admin and filters.user_id and expenses %}
<div class="alert alert-info d-flex align-items-center mt-3">
  <strong class="me-2">Viewing expenses for:</strong>
  <span class="fw-semibold">{{ expenses[0].owner }}</span>
</div>
{% endif %}

    <div class="text-muted small">
  {% if admin and not filters.user_id %}
    Admin view: all users
  {% elif admin and filters.user_id %}
    Admin view: filtered by user
  {% else %}
    Your expenses
  {% endif %}
</div>

  </div>
  <a class="btn btn-primary" href="{{ url_for('add_expense') }}">+ Add Expense</a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="mb-3"></h5>

    <form method="get" class="row g-2">
      <div class="col-md-3">
        <label class="form-label">Category</label>
        <select class="form-select" name="category_id">
          <option value="">All</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if filters.category_id == (c.id|string) %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">From</label>
        <input class="form-control" type="date" name="from" value="{{ filters.from }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">To</label>
        <input class="form-control" type="date" name="to" value="{{ filters.to }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Essential?</label>
        <select class="form-select" name="essential">
          <option value="">All</option>
          <option value="1" {% if filters.essential == "1" %}selected{% endif %}>Essential only</option>
          <option value="0" {% if filters.essential == "0" %}selected{% endif %}>Non-essential only</option>
        </select>
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-outline-dark w-100" type="submit">Apply</button>
      </div>

      {% if admin %}
<div class="col-md-3">
  <label class="form-label">User</label>
  <select name="user_id" class="form-select">
    <option value="">All users</option>
    {% for u in users %}
      <option value="{{ u.id }}"
        {% if filters.user_id == (u.id|string) %}selected{% endif %}>
        {{ u.username }}
      </option>
    {% endfor %}
  </select>
</div>
{% endif %}

    </form>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-muted small">Total (filtered)</div>
        <div class="display-6">£{{ "%.2f"|format(total) }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="mb-3">Totals by Category</h5>
        {% if totals_by_category %}
          <ul class="mb-0">
            {% for k, v in totals_by_category.items() %}
              <li>{{ k }}: £{{ "%.2f"|format(v) }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">No data to summarise.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
   {% if not admin %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="mb-3">Monthly Budget ({{ month }})</h5>

    {% if monthly_budget > 0 %}
      <p><strong>Budget:</strong> £{{ "%.2f"|format(monthly_budget) }}</p>
      <p><strong>Spent:</strong> £{{ "%.2f"|format(total) }}</p>
      <p>
        <strong>Remaining:</strong>
        <span class="{% if remaining_budget < 0 %}text-danger{% else %}text-success{% endif %}">
          £{{ "%.2f"|format(remaining_budget) }}
        </span>
      </p>
    {% else %}
      <div class="alert alert-warning mb-3">
        No budget set for this month.
      </div>
    {% endif %}

    <form method="post" action="{{ url_for('set_budget') }}" class="row g-2 mt-3">
      <input type="hidden" name="month" value="{{ month }}">

      <div class="col-md-6">
        <input
          type="number"
          step="0.01"
          name="amount"
          class="form-control"
          placeholder="Enter monthly budget (£)"
          required
        >
      </div>

      <div class="col-md-3">
        <button class="btn btn-primary w-100" type="submit">
          Save Budget
        </button>
      </div>
    </form>

  </div>
</div>
{% endif %}

  </div>
</div>

    <h5 class="mb-3">Expense List</h5>

    {% if expenses %}
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Description</th>
              <th class="text-end">Amount</th>
              <th>Essential</th>
              {% if admin %}<th>User</th>{% endif %}
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for e in expenses %}
              <tr>
                <td>{{ e.expense_date }}</td>
                <td><span class="badge bg-secondary">{{ e.category_name }}</span></td>
                <td>{{ e.description }}</td>
                <td class="text-end">£{{ "%.2f"|format(e.amount) }}</td>
                <td>
                  {% if e.is_essential == 1 %}
                    <span class="badge bg-success">Yes</span>
                  {% else %}
                    <span class="badge bg-light text-dark">No</span>
                  {% endif %}
                </td>
                {% if admin %}<td>{{ e.owner }}</td>{% endif %}
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('edit_expense', expense_id=e.id) }}">Edit</a>
                  <form method="post" action="{{ url_for('delete_expense', expense_id=e.id) }}" class="d-inline"
                        onsubmit="return confirm('Delete this expense?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">No expenses found for these filters.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
